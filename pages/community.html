// Complete Checkout.js - Fixed for API Integration
(function() {
    'use strict';
    
    console.log('üõí Initializing checkout system...');
    
    // Checkout state
    let checkoutState = {
        cart: [],
        customer: {},
        shipping: 300,
        freeShippingThreshold: 5000,
        isProcessing: false
    };
    
    // Initialize checkout
    function initializeCheckout() {
        console.log('üéØ Checkout initialization started...');
        
        try {
            // Load cart data
            loadCartData();
            
            // Setup form handlers
            setupCheckoutForm();
            
            // Update checkout summary
            updateCheckoutSummary();
            
            console.log('‚úÖ Checkout initialized successfully');
            
        } catch (error) {
            console.error('‚ùå Checkout initialization error:', error);
            showCheckoutToast('Erreur d\'initialisation du checkout', 'error');
        }
    }
    
    function loadCartData() {
        // Get cart from main app or localStorage
        if (window.app && typeof window.app.getCart === 'function') {
            checkoutState.cart = window.app.getCart();
        } else {
            checkoutState.cart = JSON.parse(localStorage.getItem('cart') || '[]');
        }
        
        console.log(`üì¶ Loaded ${checkoutState.cart.length} items in cart`);
    }
    
    function setupCheckoutForm() {
        const checkoutForm = document.getElementById('checkoutForm');
        if (checkoutForm) {
            checkoutForm.addEventListener('submit', handleCheckoutSubmit);
            console.log('‚úÖ Checkout form handler attached');
        }
        
        // Auto-fill form if user is logged in
        if (window.app && typeof window.app.getCurrentUser === 'function') {
            const user = window.app.getCurrentUser();
            if (user) {
                prefillUserData(user);
            }
        }
    }
    
    function prefillUserData(user) {
        console.log('üë§ Pre-filling user data...');
        
        const form = document.getElementById('checkoutForm');
        if (!form) return;
        
        // Fill available user data
        const emailField = form.querySelector('[name="email"]');
        if (emailField && user.email) {
            emailField.value = user.email;
        }
        
        const nomField = form.querySelector('[name="nom"]');
        if (nomField && user.nom) {
            nomField.value = user.nom;
        }
        
        const prenomField = form.querySelector('[name="prenom"]');
        if (prenomField && user.prenom) {
            prenomField.value = user.prenom;
        }
        
        const telephoneField = form.querySelector('[name="telephone"]');
        if (telephoneField && user.telephone) {
            telephoneField.value = user.telephone;
        }
    }
    
    function updateCheckoutSummary() {
        const summaryContainer = document.getElementById('checkoutSummary');
        if (!summaryContainer) return;
        
        const subtotal = checkoutState.cart.reduce((sum, item) => sum + (item.prix * item.quantite), 0);
        const shipping = subtotal >= checkoutState.freeShippingThreshold ? 0 : checkoutState.shipping;
        const total = subtotal + shipping;
        
        summaryContainer.innerHTML = `
            <div class="bg-gray-50 rounded-lg p-4">
                <h3 class="font-semibold text-lg mb-4">R√©sum√© de la commande</h3>
                
                <!-- Items -->
                <div class="space-y-2 mb-4">
                    ${checkoutState.cart.map(item => `
                        <div class="flex justify-between text-sm">
                            <span>${item.nom} x${item.quantite}</span>
                            <span>${item.prix * item.quantite} DZD</span>
                        </div>
                    `).join('')}
                </div>
                
                <!-- Totals -->
                <div class="border-t pt-4 space-y-2">
                    <div class="flex justify-between">
                        <span>Sous-total:</span>
                        <span>${subtotal} DZD</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Livraison:</span>
                        <span>${shipping === 0 ? 'Gratuite' : shipping + ' DZD'}</span>
                    </div>
                    ${shipping === 0 ? '<div class="text-sm text-green-600">üéâ Livraison gratuite!</div>' : ''}
                    <div class="border-t pt-2 flex justify-between font-bold text-lg">
                        <span>Total:</span>
                        <span>${total} DZD</span>
                    </div>
                </div>
            </div>
        `;
        
        console.log(`üí∞ Checkout summary updated: ${total} DZD`);
    }
    
    async function handleCheckoutSubmit(e) {
        e.preventDefault();
        
        if (checkoutState.isProcessing) {
            console.warn('‚ö†Ô∏è Checkout already in progress');
            return;
        }
        
        console.log('üìã Processing checkout submission...');
        
        try {
            checkoutState.isProcessing = true;
            showProcessingState(true);
            
            // Validate cart
            if (checkoutState.cart.length === 0) {
                throw new Error('Votre panier est vide');
            }
            
            // Get form data
            const formData = new FormData(e.target);
            const orderData = extractOrderData(formData);
            
            // Validate form data
            validateOrderData(orderData);
            
            // Submit order
            const order = await submitOrder(orderData);
            
            // Handle success
            await handleOrderSuccess(order);
            
        } catch (error) {
            console.error('‚ùå Checkout error:', error);
            showCheckoutToast(error.message || 'Erreur lors de la commande', 'error');
        } finally {
            checkoutState.isProcessing = false;
            showProcessingState(false);
        }
    }
    
    function extractOrderData(formData) {
        const subtotal = checkoutState.cart.reduce((sum, item) => sum + (item.prix * item.quantite), 0);
        const shipping = subtotal >= checkoutState.freeShippingThreshold ? 0 : checkoutState.shipping;
        const total = subtotal + shipping;
        
        return {
            numeroCommande: generateOrderNumber(),
            client: {
                prenom: formData.get('prenom'),
                nom: formData.get('nom'),
                email: formData.get('email'),
                telephone: formData.get('telephone'),
                adresse: formData.get('adresse'),
                wilaya: formData.get('wilaya')
            },
            articles: checkoutState.cart.map(item => ({
                id: item.id,
                nom: item.nom,
                prix: item.prix,
                quantite: item.quantite,
                image: item.image
            })),
            sousTotal: subtotal,
            fraisLivraison: shipping,
            total: total,
            modePaiement: formData.get('modePaiement'),
            commentaires: formData.get('commentaires') || '',
            dateCommande: new Date().toISOString(),
            status: 'pending'
        };
    }
    
    function validateOrderData(orderData) {
        console.log('üîç Validating order data...');
        
        const required = ['prenom', 'nom', 'email', 'telephone', 'adresse', 'wilaya'];
        const missing = required.filter(field => !orderData.client[field] || orderData.client[field].trim() === '');
        
        if (missing.length > 0) {
            throw new Error(`Veuillez remplir tous les champs obligatoires: ${missing.join(', ')}`);
        }
        
        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(orderData.client.email)) {
            throw new Error('Veuillez saisir une adresse email valide');
        }
        
        // Validate phone number
        const phoneRegex = /^[0-9+\s-]{8,15}$/;
        if (!phoneRegex.test(orderData.client.telephone)) {
            throw new Error('Veuillez saisir un num√©ro de t√©l√©phone valide');
        }
        
        console.log('‚úÖ Order data validation passed');
    }
    
    async function submitOrder(orderData) {
        console.log('üì§ Submitting order to server...');
        
        try {
            // Try API submission first
            const response = await apiCall('/orders', {
                method: 'POST',
                body: JSON.stringify(orderData)
            });
            
            console.log('‚úÖ Order submitted successfully via API');
            return response;
            
        } catch (error) {
            console.warn('‚ö†Ô∏è API submission failed, using fallback:', error.message);
            
            // Fallback to localStorage
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            orders.push(orderData);
            localStorage.setItem('orders', JSON.stringify(orders));
            
            console.log('üíæ Order saved to localStorage as fallback');
            return orderData;
        }
    }
    
    async function handleOrderSuccess(order) {
        console.log('üéâ Order success, handling post-submission...');
        
        // Clear cart
        clearCart();
        
        // Update order count
        const orderCount = parseInt(localStorage.getItem('orderCount') || '0') + 1;
        localStorage.setItem('orderCount', orderCount.toString());
        
        // Show success message
        showOrderSuccessModal(order);
        
        // Redirect to home after delay
        setTimeout(() => {
            if (window.app && typeof window.app.showPage === 'function') {
                window.app.showPage('home');
            }
        }, 3000);
    }
    
    function clearCart() {
        checkoutState.cart = [];
        localStorage.setItem('cart', '[]');
        
        // Update main app cart if available
        if (window.app && typeof window.app.updateCartUI === 'function') {
            window.app.cart = [];
            window.app.updateCartUI();
        }
        
        console.log('üßπ Cart cleared successfully');
    }
    
    function showOrderSuccessModal(order) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4 text-center">
                <div class="mb-6">
                    <div class="mx-auto w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-check text-green-600 text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Commande confirm√©e!</h3>
                    <p class="text-gray-600">Votre commande a √©t√© enregistr√©e avec succ√®s.</p>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="text-sm text-gray-600 mb-2">Num√©ro de commande:</div>
                    <div class="font-bold text-lg">${order.numeroCommande}</div>
                </div>
                
                <div class="space-y-2 text-sm text-gray-600 mb-6">
                    <p><strong>Total:</strong> ${order.total} DZD</p>
                    <p><strong>Mode de paiement:</strong> ${getPaymentMethodText(order.modePaiement)}</p>
                    <p><strong>Livraison:</strong> ${order.client.adresse}, ${order.client.wilaya}</p>
                </div>
                
                <div class="space-y-3">
                    <p class="text-sm text-gray-600">Nous vous contacterons bient√¥t pour confirmer votre commande.</p>
                    <button onclick="this.closest('.fixed').remove()" 
                            class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700">
                        Fermer
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Auto-remove after 10 seconds
        setTimeout(() => {
            if (document.body.contains(modal)) {
                modal.remove();
            }
        }, 10000);
    }
    
    function generateOrderNumber() {
        const timestamp = Date.now().toString().slice(-6);
        const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        return `CMD${timestamp}${random}`;
    }
    
    function getPaymentMethodText(method) {
        switch (method) {
            case 'cash': return 'Paiement √† la livraison';
            case 'transfer': return 'Virement bancaire';
            case 'card': return 'Carte bancaire';
            default: return method;
        }
    }
    
    function showProcessingState(isProcessing) {
        const submitBtn = document.querySelector('#checkoutForm button[type="submit"]');
        if (submitBtn) {
            if (isProcessing) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Traitement en cours...';
            } else {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Confirmer la commande';
            }
        }
        
        // Show/hide loading overlay
        const loadingSpinner = document.getElementById('loading-spinner');
        if (loadingSpinner) {
            loadingSpinner.classList.toggle('hidden', !isProcessing);
        }
    }
    
    function showCheckoutToast(message, type = 'info') {
        console.log(`üîî Checkout toast: ${message} (${type})`);
        
        // Use main app toast if available
        if (window.app && typeof window.app.showToast === 'function') {
            window.app.showToast(message, type);
        } else {
            // Fallback toast
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
            }`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }
    }
    
    // Auto-update checkout summary when cart changes
    function handleCartUpdate() {
        loadCartData();
        updateCheckoutSummary();
    }
    
    // Listen for cart updates
    window.addEventListener('storage', (e) => {
        if (e.key === 'cart') {
            handleCartUpdate();
        }
    });
    
    // Custom event listener for cart updates within the same page
    window.addEventListener('cartUpdated', handleCartUpdate);
    
    // Global exports
    window.initializeCheckout = initializeCheckout;
    window.updateCheckoutSummary = updateCheckoutSummary;
    
    console.log('‚úÖ Checkout system loaded successfully');
    
})();
